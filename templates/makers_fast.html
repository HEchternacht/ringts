<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Makers Section</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Live Makers Feed Sidebar -->
        <div class="live-feed-sidebar" id="makersLiveFeed">
            <div class="live-feed-header">
                <h3>üîß Makers Live Feed</h3>
                <span class="live-indicator">LIVE</span>
            </div>
            <div class="live-feed-content" id="makersLiveFeedContent">
                <div class="live-feed-placeholder">
                    <p>Waiting for Makers updates...</p>
                </div>
            </div>
        </div>

        <div class="main-content">
        <nav class="main-nav">
            <a href="/" class="nav-link">Dashboard</a>
            <a href="/vip" class="nav-link">VIP Tracking</a>
            <a href="/makers" class="nav-link active">Makers Section</a>
        </nav>

        <header>
            <h1>üîß Makers Section</h1>
            <p class="subtitle">Track maker players in real-time</p>
        </header>

        <div style="padding: 30px;">
        <!-- Makers List Section -->
        <section class="section-card">
            <h2>Makers List</h2>
            <div id="makersList" class="vip-list"></div>
        </section>

        <!-- Main Makers List Section -->
        <section class="section-card">
            <h2>Main Makers Relationships</h2>
            <p class="section-description">Characters and their associated maker accounts</p>
            <div id="mainMakersTable" class="detail-data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Main Character</th>
                            <th>Main World</th>
                            <th>Maker Character</th>
                            <th>Maker World</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="mainMakersTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>
        </div>

        <!-- Player Modal (same as dashboard) -->
        <div class="modal" id="playerModal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2 id="modalPlayerName">Player Details</h2>
                    <span class="modal-close" onclick="closePlayerModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="modal-main-tabs">
                        <button class="modal-main-tab-btn active" onclick="switchModalMainTab('raw-graph')">üìä Raw Graph</button>
                        <button class="modal-main-tab-btn" onclick="switchModalMainTab('multi-graph')">üìà Multi-Graph</button>
                        <button class="modal-main-tab-btn" onclick="switchModalMainTab('tables')">üìã Tables</button>
                    </div>

                    <div class="modal-tab-content active" id="modal-raw-graph">
                        <div id="modalGraphDiv" style="width: 100%; height: 500px;"></div>
                    </div>

                    <div class="modal-tab-content" id="modal-multi-graph">
                        <div class="loading-overlay" id="multiGraphLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p>Loading multi-graph...</p>
                        </div>
                        <div id="modalMultiGraphDiv" class="combined-overview-chart"></div>
                    </div>

                    <div class="modal-tab-content" id="modal-tables">
                        <div class="loading-overlay" id="playerDetailsLoading">
                            <div class="loading-spinner"></div>
                            <p>Loading player details...</p>
                        </div>
                        <div id="playerDetailsContent" class="player-details-content" style="display: none;">
                            <!-- Player details will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <section class="section-card">
            <h2>Upload Makers Data</h2>
            <p class="section-description">Upload a CSV file to update the main makers relationships. The file must have columns: main, main_world, maker, maker_world</p>
            
            <div class="upload-container">
                <input type="password" id="makersPassword" placeholder="Upload password" class="password-input" />
                <input type="file" id="uploadMakers" accept=".csv" style="display: none;" />
                <button class="btn-secondary" onclick="document.getElementById('uploadMakers').click()">‚¨ÜÔ∏è Upload ref_main_maker.csv</button>
                <div id="uploadMakersStatus" class="status-message"></div>
            </div>
            
            <div class="upload-info">
                <h4>CSV Format Requirements:</h4>
                <ul>
                    <li>Columns: <code>main,main_world,maker,maker_world</code></li>
                    <li>Example: <code>Lucs Enn,Auroria,rtc defenderr,spectrum</code></li>
                    <li>Password is required to upload files</li>
                    <li>Current data will be backed up before replacement</li>
                </ul>
            </div>
        </section>

        </div>
        <!-- End main-content -->
    </div>

    <script src="/static/app.js"></script>
    <script>
        let makersEventSource = null;
        let makersDeltas = [];
        let makersDeltasByDate = new Map();
        let makersDeltaIds = new Set();

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Makers page loaded');
            loadMakersList();
            loadMainMakersList();
            connectMakersStream();
            
            // Upload functionality
            document.getElementById('uploadMakers').addEventListener('change', handleMakersUpload);
            
            // No add/remove functionality for makers
        });

        // Load Makers list
        async function loadMakersList() {
            try {
                const response = await fetch('/api/makers/list');
                const data = await response.json();
                
                const makersList = document.getElementById('makersList');
                makersList.innerHTML = '';
                
                if (data.makers && data.makers.length > 0) {
                    data.makers.forEach(maker => {
                        const makerItem = document.createElement('div');
                        makerItem.className = 'vip-item';
                        makerItem.innerHTML = `
                            <div class="vip-info">
                                <div class="vip-name">${maker.name}</div>
                                <div class="vip-world">${maker.world}</div>
                            </div>
                            <div class="vip-selector">
                                <button onclick="showMakersModal('${maker.name}', '${maker.world}')" class="btn btn-secondary">View</button>
                            </div>
                        `;
                        makersList.appendChild(makerItem);
                    });
                } else {
                    makersList.innerHTML = '<p>No makers configured.</p>';
                }
            } catch (error) {
                console.error('Error loading makers list:', error);
                document.getElementById('makersList').innerHTML = '<p>Error loading makers list.</p>';
            }
        }

        // Load Main Makers list
        async function loadMainMakersList() {
            try {
                const response = await fetch('/api/makers/main');
                const data = await response.json();
                
                const tableBody = document.getElementById('mainMakersTableBody');
                tableBody.innerHTML = '';
                
                if (data.main_makers && data.main_makers.length > 0) {
                    data.main_makers.forEach(relationship => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${relationship.main}</strong></td>
                            <td>${relationship.main_world}</td>
                            <td>${relationship.maker}</td>
                            <td>${relationship.maker_world}</td>
                            <td>
                                <button onclick="showMakersModal('${relationship.main}', '${relationship.main_world}')" class="btn btn-secondary btn-small">View Main</button>
                                <button onclick="showMakersModal('${relationship.maker}', '${relationship.maker_world}')" class="btn btn-secondary btn-small">View Maker</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No main makers configured.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading main makers list:', error);
                document.getElementById('mainMakersTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center; color: #dc3545;">Error loading main makers list.</td></tr>';
            }
        }

        // Handle Makers CSV upload
        async function handleMakersUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const statusDiv = document.getElementById('uploadMakersStatus');
            const passwordInput = document.getElementById('makersPassword');
            const password = passwordInput.value.trim();
            
            if (!password) {
                statusDiv.textContent = '‚ùå Error: Password is required';
                statusDiv.className = 'status-message error';
                event.target.value = '';
                return;
            }
            
            statusDiv.textContent = 'Uploading...';
            statusDiv.className = 'status-message info';
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('password', password);
            
            try {
                const response = await fetch('/api/upload/makers', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    statusDiv.textContent = `‚úÖ Successfully uploaded ${data.records} records. Backup created.`;
                    statusDiv.className = 'status-message success';
                    passwordInput.value = ''; // Clear password
                    
                    // Reload the main makers table
                    loadMainMakersList();
                } else if (response.status === 401) {
                    statusDiv.textContent = '‚ùå Error: Invalid password';
                    statusDiv.className = 'status-message error';
                } else {
                    statusDiv.textContent = `‚ùå Error: ${data.detail || 'Unknown error'}`;
                    statusDiv.className = 'status-message error';
                }
            } catch (error) {
                statusDiv.textContent = `‚ùå Error: ${error.message}`;
                statusDiv.className = 'status-message error';
            }
            
            // Clear the file input
            event.target.value = '';
        }

        // Close modal function
        function closePlayerModal() {
            const modal = document.getElementById('playerModal');
            
            // Remove active class to close modal (same as main app.js)
            modal.classList.remove('active');
            
            // Clear modal content for fresh load next time
            const modalGraphDiv = document.getElementById('modalGraphDiv');
            const modalMultiGraphDiv = document.getElementById('modalMultiGraphDiv');
            const playerDetailsContent = document.getElementById('playerDetailsContent');
            
            // Purge Plotly graphs properly
            if (modalGraphDiv) {
                if (modalGraphDiv._fullLayout) {
                    Plotly.purge(modalGraphDiv);
                }
            }
            if (modalMultiGraphDiv) {
                if (modalMultiGraphDiv._fullLayout) {
                    Plotly.purge(modalMultiGraphDiv);
                }
            }
            if (playerDetailsContent) {
                playerDetailsContent.innerHTML = '';
            }
            
            // Clear cache for this player (same as main app.js)
            const playerName = modal.dataset.playerName;
            if (playerName && typeof playerDetailsCache !== 'undefined' && playerDetailsCache[playerName]) {
                delete playerDetailsCache[playerName];
            }
        }

        // Override switchModalMainTab for Makers page - use same logic as app.js
        function switchModalMainTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.modal-main-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.modal-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`modal-${tabName}`).classList.add('active');
            
            // Get player name from modal data attribute (same as main app.js)
            const modal = document.getElementById('playerModal');
            const playerName = modal.dataset.playerName;
            
            if (!playerName) {
                console.error('No player name in modal');
                return;
            }
            
            console.log('Switching to tab:', tabName, 'for player:', playerName);
            
            // If switching to raw-graph tab, ensure data is loaded
            if (tabName === 'raw-graph') {
                // Load raw graph data if not already loaded
                if (!makersModalCache[playerName]) {
                    loadMakersGraph(playerName, modal.dataset.playerWorld);
                }
            } else if (tabName === 'multi-graph') {
                // Load multi-graph data (scraped player data)
                if (typeof loadPlayerDetailsForMultiGraph === 'function') {
                    loadPlayerDetailsForMultiGraph(playerName);
                } else {
                    console.error('loadPlayerDetailsForMultiGraph not available');
                }
            } else if (tabName === 'tables') {
                // Load table data
                loadPlayerDetails(playerName, 'modal');
            }
        }

        // Makers modal cache - use global playerDetailsCache if available
        let makersModalCache = {};

        // Show Makers modal with data
        async function showMakersModal(name, world) {
            console.log('showMakersModal called for:', name, world);
            try {
                const modal = document.getElementById('playerModal');
                modal.dataset.playerName = name;
                modal.dataset.playerWorld = world;
                modal.classList.add('active');
                
                document.getElementById('modalPlayerName').textContent = `${name} (${world})`;
                
                // Manually switch to raw graph tab (like VIPs)
                document.querySelectorAll('.modal-main-tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.modal-tab-content').forEach(content => content.classList.remove('active'));
                document.querySelector('.modal-main-tab-btn').classList.add('active');
                document.getElementById('modal-raw-graph').classList.add('active');
                
                // Load makers graph data (exp + online time) - even if empty
                await loadMakersGraph(name, world);
                
                // Preload player details for tables and multigraph tabs (like VIPs)
                await loadPlayerDetails(name, 'modal');
                if (typeof loadPlayerDetailsForMultiGraph === 'function') {
                    await loadPlayerDetailsForMultiGraph(name);
                }
            } catch (error) {
                console.error('Error showing makers modal:', error);
                showNotification(`‚ùå Failed to load maker data: ${error.message}`, 'error');
            }
        }

        // Load Makers graph data (exp + online time)
        async function loadMakersGraph(name, world) {
            console.log('Loading Makers graph for:', name, world);
            const graphDiv = document.getElementById('modalGraphDiv');
            
            if (!graphDiv) {
                console.error('modalGraphDiv not found');
                return;
            }
            
            // Show loading with proper structure
            graphDiv.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100%;"><div class="loading-spinner"></div></div>';
            
            try {
                const response = await fetch('/api/makers/graph', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        world: world
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.graph_data) {
                    // Clear loading
                    graphDiv.innerHTML = '';
                    
                    // Render the graph
                    const graphData = JSON.parse(data.graph_data);
                    Plotly.newPlot(graphDiv, graphData.data, graphData.layout, {responsive: true});
                    
                    // Cache the data
                    makersModalCache[name] = data;
                    
                    console.log('Makers graph loaded successfully');
                } else {
                    throw new Error(data.error || 'Failed to load graph data');
                }
            } catch (error) {
                console.error('Error loading makers graph:', error);
                graphDiv.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100%;"><p>Error loading graph</p></div>';
                showNotification(`‚ùå Failed to load makers graph: ${error.message}`, 'error');
            }
        }

        // Notification function (reuse from app.js if available, or define here)
        function showNotification(message, type = 'info') {
            // Try to use global function from app.js if available
            if (typeof window.showNotification === 'function') {
                window.showNotification(message, type);
                return;
            }
            
            // Fallback notification
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            // Create a simple notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">√ó</button>
            `;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#ff4444' : type === 'success' ? '#44ff44' : '#4444ff'};
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 10000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Connect to Makers delta stream (using polling like main dashboard)
        async function connectMakersStream() {
            console.log('Connecting to makers stream...');
            loadMakersDeltas();
            setInterval(loadMakersDeltas, 30000); // Poll every 30 seconds
        }

        // Load Makers deltas via polling
        async function loadMakersDeltas() {
            try {
                const response = await fetch('/api/makers/deltas?limit=50');
                const data = await response.json();
                
                if (data.deltas) {
                    // Process new deltas
                    data.deltas.forEach(delta => {
                        const deltaId = `${delta.name}-${delta.update_time}`;
                        if (!makersDeltaIds.has(deltaId)) {
                            makersDeltaIds.add(deltaId);
                            addMakersDeltaToFeed(delta);
                        }
                    });
                    
                    // Update the feed display
                    renderMakersDeltaFeed();
                }
            } catch (error) {
                console.error('Error loading makers deltas:', error);
            }
        }

        // Add Makers delta to live feed (using dashboard style)
        function addMakersDeltaToFeed(delta) {
            const deltaTime = new Date(delta.update_time);
            const dateKey = deltaTime.toISOString().split('T')[0];
            
            if (!makersDeltasByDate.has(dateKey)) {
                makersDeltasByDate.set(dateKey, []);
            }
            
            makersDeltasByDate.get(dateKey).push({
                ...delta,
                timestamp: deltaTime
            });
            
            // Keep only recent deltas (last 24 hours)
            const oneDayAgo = new Date();
            oneDayAgo.setHours(oneDayAgo.getHours() - 24);
            
            for (const [date, deltas] of makersDeltasByDate) {
                makersDeltasByDate.set(date, deltas.filter(d => d.timestamp > oneDayAgo));
            }
        }

        function renderMakersDeltaFeed() {
            const feedContent = document.getElementById('makersLiveFeedContent');
            
            // Clear existing content
            feedContent.innerHTML = '';
            
            if (makersDeltasByDate.size === 0) {
                feedContent.innerHTML = '<div class="live-feed-placeholder"><p>Waiting for Makers updates...</p></div>';
                return;
            }
            
            // Sort dates descending
            const sortedDates = Array.from(makersDeltasByDate.keys()).sort().reverse();
            
            for (const date of sortedDates) {
                const deltas = makersDeltasByDate.get(date);
                if (deltas.length === 0) continue;
                
                const dateGroup = document.createElement('div');
                dateGroup.className = 'delta-date-group';
                
                const dateHeader = document.createElement('div');
                dateHeader.className = 'delta-date-header';
                dateHeader.innerHTML = `<h4>${new Date(date).toLocaleDateString()}</h4>`;
                dateGroup.appendChild(dateHeader);
                
                // Sort deltas by time descending
                deltas.sort((a, b) => b.timestamp - a.timestamp);
                
                deltas.forEach(delta => {
                    const deltaItem = document.createElement('div');
                    deltaItem.className = 'delta-item new';
                    
                    const deltaExp = delta.delta_online;
                    const isPositive = deltaExp > 0;
                    
                    deltaItem.innerHTML = `
                        <div class="delta-player-name">${delta.name}</div>
                        <div class="delta-exp-value ${isPositive ? 'positive' : 'negative'}">
                            ${isPositive ? '+' : ''}${formatNumber(deltaExp)}m
                        </div>
                        <div class="delta-time">${delta.timestamp.toLocaleTimeString()}</div>
                    `;
                    
                    dateGroup.appendChild(deltaItem);
                    
                    // Remove 'new' class after animation
                    setTimeout(() => {
                        deltaItem.classList.remove('new');
                    }, 3000);
                });
                
                feedContent.appendChild(dateGroup);
            }
        }

        // Format number helper
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // Load Makers graph
        async function loadMakersGraph(name, world) {
            console.log('Loading Makers graph for:', name, world);
            // This is already implemented above
        }
    </script>

    <style>
        /* CSS Variables */
        :root {
            --primary-color: #C21500;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #333333;
            --border-color: #e9ecef;
        }
        
        .vip-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .vip-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .vip-info {
            display: flex;
            flex-direction: column;
        }

        .vip-name {
            font-weight: bold;
            font-size: 16px;
            color: var(--text-color);
        }

        .vip-world {
            font-size: 14px;
            color: #666;
        }

        .vip-selector {
            display: flex;
            gap: 10px;
        }

        .vip-selector select {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
        }

        #makersGraphContainer {
            margin-top: 20px;
        }

        .delta-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        .delta-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: var(--card-background);
            border-left: 4px solid var(--secondary-color);
            border-radius: 4px;
            animation: slideIn 0.3s ease-out;
        }

        .delta-item.positive {
            border-left-color: var(--success-color);
        }

        .delta-item.negative {
            border-left-color: var(--danger-color);
        }

        .delta-player {
            font-weight: bold;
        }

        .delta-exp {
            font-weight: bold;
        }

        .delta-item.positive .delta-exp {
            color: var(--success-color);
        }

        .delta-item.negative .delta-exp {
            color: var(--danger-color);
        }

        .delta-time {
            font-size: 12px;
            color: #666;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .stats-card {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-color);
        }

        .main-nav {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            padding: 10px 15px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .nav-link:hover {
            background-color: var(--background-color);
        }

        .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* Notification animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 0;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Modal centering */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal.active,
        .modal[style*="display: flex"] {
            display: flex;
        }

        /* Upload section styles */
        .upload-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .upload-info h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 16px;
        }

        .upload-info ul {
            margin: 0;
            padding-left: 20px;
        }

        .upload-info li {
            margin-bottom: 5px;
            color: #6c757d;
        }

        .upload-info code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
    </style>
</body>
</html>